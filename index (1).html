<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control - Refugio</title>
    
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>

    <style>
        body { font-family: sans-serif; background-color: #fff5e6; padding: 20px; text-align: center; }
        .formulario, .lista { background: white; padding: 20px; border-radius: 15px; max-width: 450px; margin: 20px auto; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        input, textarea, select { width: 90%; margin: 10px 0; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; }
        
        /* Estilos del Bot√≥n de Subir Foto */
        .btn-foto { background: #9C27B0; color: white; border: none; padding: 12px; width: 100%; border-radius: 8px; cursor: pointer; font-weight: bold; margin-bottom: 10px; }
        .preview-img { max-width: 150px; display: none; margin: 10px auto; border-radius: 8px; border: 2px solid #ddd; }

        .btn-subir { background: #ff9800; color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        .btn-actualizar { background: #2196F3; color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; cursor: pointer; font-weight: bold; display: none; margin-top: 10px;}
        
        .item-perro { display: flex; flex-direction: column; border-bottom: 1px solid #eee; padding: 15px 0; text-align: left; }
        .acciones { display: flex; gap: 10px; margin-top: 10px; }
        .btn-borrar { background: #ff4444; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; flex: 1; }
        .btn-editar { background: #4CAF50; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; flex: 1; }
    </style>
</head>
<body>

    <div class="formulario">
        <h2 id="titulo-form">A√±adir Nuevo Perrito üêï</h2>
        
        <input type="text" id="nombre" placeholder="Nombre">
        <input type="text" id="edad" placeholder="Edad (ej: 6 meses)">
        <select id="sexo">
            <option value="Macho ‚ôÇÔ∏è">Macho ‚ôÇÔ∏è</option>
            <option value="Hembra ‚ôÄÔ∏è">Hembra ‚ôÄÔ∏è</option>
        </select>
        <textarea id="desc" placeholder="Descripci√≥n"></textarea>
        
        <button type="button" id="upload_widget" class="btn-foto">üì∏ Subir Foto</button>
        <img id="imagen_previa" class="preview-img" src="">
        
        <input type="hidden" id="urlFoto">
        
        <button id="btnPublicar" class="btn-subir">Publicar en la Web</button>
        <button id="btnActualizar" class="btn-actualizar">Guardar Cambios</button>
        <button id="btnCancelar" style="display:none; background:none; border:none; color:grey; margin-top:10px; cursor:pointer;">Cancelar Edici√≥n</button>
    </div>

    <div class="lista">
        <h3>Perritos en Adopci√≥n</h3>
        <div id="lista-admin">Cargando perritos...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyB0ahP8K53dm8BIRhjXYxCbSJ8sNfQi-NI",
          authDomain: "refugio-de-patitas.firebaseapp.com",
          projectId: "refugio-de-patitas",
          storageBucket: "refugio-de-patitas.firebasestorage.app",
          messagingSenderId: "5921473252",
          appId: "1:5921473252:web:16f18c4c7cf1ad1509e2f1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let idEdicion = null;

        // 1. FUNCI√ìN PUBLICAR (Modificada para validar foto)
        document.getElementById('btnPublicar').onclick = async () => {
            const nombre = document.getElementById('nombre').value;
            const urlFoto = document.getElementById('urlFoto').value;

            if(!nombre) return alert("Escribe el nombre");
            if(!urlFoto) return alert("¬°Falta subir la foto del perrito!");

            try {
                await addDoc(collection(db, "perritos"), {
                    nombre: nombre,
                    edad: document.getElementById('edad').value,
                    sexo: document.getElementById('sexo').value,
                    desc: document.getElementById('desc').value,
                    fotoUrl: urlFoto,
                    fecha: new Date()
                });
                limpiarFormulario();
                alert("¬°Publicado!");
            } catch (e) { alert("Error: " + e); }
        };

        // 2. MOSTRAR LISTA
        onSnapshot(collection(db, "perritos"), (snapshot) => {
            const divLista = document.getElementById('lista-admin');
            divLista.innerHTML = '';
            snapshot.forEach((res) => {
                const perro = res.data();
                const idDoc = res.id;
                const divPerro = document.createElement('div');
                divPerro.className = 'item-perro';
                // Agregu√© una miniatura de la foto en la lista
                divPerro.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px;">
                        <img src="${perro.fotoUrl}" style="width:40px; height:40px; border-radius:50%; object-fit:cover;">
                        <span><strong>${perro.nombre}</strong> - ${perro.sexo || 'Sin definir'}</span>
                    </div>
                    <div class="acciones">
                        <button class="btn-editar" onclick="prepararEdicion('${idDoc}', '${perro.nombre}', '${perro.edad}', '${perro.sexo}', '${perro.desc}', '${perro.fotoUrl}')">Editar</button>
                        <button class="btn-borrar" onclick="eliminarPerro('${idDoc}', '${perro.nombre}')">Eliminar</button>
                    </div>
                `;
                divLista.appendChild(divPerro);
            });
        });

        // 3. EDITAR
        window.prepararEdicion = (id, nombre, edad, sexo, desc, foto) => {
            idEdicion = id;
            document.getElementById('nombre').value = nombre;
            document.getElementById('edad').value = edad;
            document.getElementById('sexo').value = sexo || "Macho ‚ôÇÔ∏è";
            document.getElementById('desc').value = desc;
            
            // Cargar foto en el input oculto y mostrar preview
            document.getElementById('urlFoto').value = foto;
            let preview = document.getElementById('imagen_previa');
            preview.src = foto;
            preview.style.display = "block";
            
            document.getElementById('titulo-form').innerText = "Editando a " + nombre;
            document.getElementById('btnPublicar').style.display = "none";
            document.getElementById('btnActualizar').style.display = "block";
            document.getElementById('btnCancelar').style.display = "inline-block";
            window.scrollTo(0,0);
        };

        // 4. ACTUALIZAR
        document.getElementById('btnActualizar').onclick = async () => {
            try {
                const perroRef = doc(db, "perritos", idEdicion);
                await updateDoc(perroRef, {
                    nombre: document.getElementById('nombre').value,
                    edad: document.getElementById('edad').value,
                    sexo: document.getElementById('sexo').value,
                    desc: document.getElementById('desc').value,
                    fotoUrl: document.getElementById('urlFoto').value
                });
                alert("¬°Cambios guardados!");
                limpiarFormulario();
            } catch (e) { alert("Error al actualizar: " + e); }
        };

        window.eliminarPerro = async (id, nombre) => {
            if(confirm("¬øBorrar a " + nombre + "?")) await deleteDoc(doc(db, "perritos", id));
        };

        document.getElementById('btnCancelar').onclick = () => limpiarFormulario();

        function limpiarFormulario() {
            idEdicion = null;
            document.querySelectorAll('input, textarea').forEach(i => i.value = "");
            document.getElementById('urlFoto').value = ""; // Limpiar link oculto
            document.getElementById('imagen_previa').style.display = "none"; // Ocultar foto
            
            document.getElementById('titulo-form').innerText = "A√±adir Nuevo Perrito üêï";
            document.getElementById('btnPublicar').style.display = "block";
            document.getElementById('btnActualizar').style.display = "none";
            document.getElementById('btnCancelar').style.display = "none";
        }
    </script>

    <script type="text/javascript">  
        var myWidget = cloudinary.createUploadWidget({
            cloudName: 'daafrfwj1',       
            uploadPreset: 'jonathan_delangel', 
            sources: ['local', 'camera'], 
            language: "es",               
            text: {
                "es": {
                    "or": "o",
                    "menu": { "files": "Mis Archivos" }
                }
            }
        }, (error, result) => { 
            if (!error && result && result.event === "success") { 
                console.log('Imagen subida! Link:', result.info.secure_url);
                
                // 1. Guardamos el link en el input oculto
                document.getElementById("urlFoto").value = result.info.secure_url;
                
                // 2. Mostramos la foto en pantalla
                var previa = document.getElementById("imagen_previa");
                previa.src = result.info.secure_url;
                previa.style.display = "block";
            }
        });

        document.getElementById("upload_widget").addEventListener("click", function(){
            myWidget.open();
        }, false);
    </script>

</body>
</html>
