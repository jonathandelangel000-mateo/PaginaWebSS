<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refugio de Patitas</title>
    <style>
                body { 
            font-family: 'Segoe UI', sans-serif; 
            margin: 0; 
            
            /* --- CAMBIO 1: FONDO DE LA LISTA DE PERRITOS --- */
            /* Cambia el link de abajo por la foto que t√∫ quieras */
            background-image: url('https://www.transparenttextures.com/patterns/cubes.png'); 
            background-color: #fdf2e9; /* Color de respaldo por si la imagen no carga */
            background-size: cover;       /* Ajusta la imagen para cubrir todo */
            background-position: center; 
            background-attachment: fixed; /* ¬°El secreto! El fondo se queda fijo al hacer scroll */
            
            display: flex; 
            flex-direction: row; 
        }

        /* Panel Lateral Izquierdo */
        .sidebar { 
            width: 300px; 
            
            /* --- CAMBIO 2: FONDO DEL T√çTULO / SIDEBAR --- */
            /* El "linear-gradient" crea una capa naranja transparente sobre tu foto para que el texto se lea */
            background: linear-gradient(rgba(255, 152, 0, 0.9), rgba(255, 152, 0, 0.7)), url('https://res.cloudinary.com/daafrfwj1/image/upload/v1771185706/peekpxjm9ljbc0crczdi.jpg');
            background-size: cover;
            background-position: center;
            
            color: white; 
            height: 100vh; 
            position: sticky; 
            top: 0; 
            padding: 30px 20px;
            box-shadow: 4px 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            box-sizing: border-box; 
        }

        /* Contenido Principal */
        .contenido-principal { 
            flex-grow: 1; 
            overflow-y: auto;
            scroll-behavior: smooth; 
        }

        /* Ajuste para Celulares */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { 
                width: 100%; 
                height: auto; 
                position: relative; 
                padding: 20px;
                box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            }
        }

        .simbolo-sexo {
            background: white;
            padding: 5px 10px;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: inline-block;
            margin: 10px 0;
            font-weight: bold;
            color: #ff9800;
        }
        
        .contenedor { display: flex; flex-wrap: wrap; justify-content: center; padding: 20px; }
        
        /* TARJETA */
        .tarjeta { 
            background: white; 
            border-radius: 20px; 
            width: 320px; 
            margin: 20px; 
            overflow: hidden; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.1); 
            transition: 0.3s; 
            display: flex; 
            flex-direction: column; 
            border: 2px solid transparent; 
        }
        
        .tarjeta-destacada {
            border: 2px solid #ff9800;
            box-shadow: 0 0 30px rgba(255, 152, 0, 0.6);
            transform: scale(1.02);
        }

        .tarjeta img { width: 100%; height: 220px; object-fit: cover; cursor: zoom-in; }
        .info { padding: 20px; text-align: left; flex-grow: 1; }
        .info h3 { color: #e68a00; margin: 0 0 10px 0; font-size: 1.6rem; text-align: center; }
        
                /* ESTILO PARA LA RAZA (MODIFICADO) */
        .raza-badge {
            background-color: #ffe0b2; /* Fondo naranja clarito */
            color: black;              /* Texto en NEGRO */
            padding: 6px 12px;         /* Un poco m√°s de espacio */
            border-radius: 12px;
            font-size: 1.2rem;         /* Letra M√ÅS GRANDE (antes era 0.9rem) */
            font-weight: 900;          /* Super NEGRITAS (Extra bold) */
            display: inline-block;
            margin-bottom: 5px;
            border: 1px solid #ff9800; /* Opcional: un borde finito para resaltar m√°s */
        }


        .btn-wa { background: #25d366; color: white; text-decoration: none; padding: 12px; display: block; border-radius: 10px; font-weight: bold; margin-top: 15px; text-align: center; box-shadow: 0 4px 8px rgba(37, 211, 102, 0.3); }
        
        /* ESTILOS PARA COMENTARIOS, LIKES Y COMPARTIR */
        .seccion-comentarios { 
            background: white; 
            padding: 10px 15px; 
            border-top: 1px solid #eee; 
            font-size: 0.9rem; 
        }
        
        .caja-comentarios-oculta {
            display: none;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ddd;
        }

        .botones-accion {
            display: flex;
            justify-content: space-between; 
            align-items: center;
            margin-top: 10px;
        }
        
        .grupo-botones-derecha {
            display: flex;
            gap: 5px;
        }

        .btn-accion {
            background: none;
            border: 1px solid #ff9800;
            color: #ff9800;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: bold;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .btn-accion:hover { background: #fff5e6; }
        .btn-compartir { border-color: #2196F3; color: #2196F3; } 
        .btn-compartir:hover { background: #e3f2fd; }

        .cont-likes { display: flex; align-items: center; gap: 5px; }
        .btn-like { background: none; border: none; font-size: 1.4rem; cursor: pointer; transition: 0.2s; padding: 0; }
        .btn-like:active { transform: scale(1.3); }
        .numero-likes { font-weight: bold; color: #555; font-size: 0.9rem; cursor: pointer; text-decoration: underline; }
        
        .comentario { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-bottom: 1px dotted #ccc; padding-bottom: 5px; color: #333; }
        .comentario b { color: #d35400; font-weight: bold; }
        .btn-borrar-com { background: none; border: none; color: #ff4444; cursor: pointer; font-size: 14px; font-weight: bold; padding: 0 5px; }
        
        .area-escribir { display: flex; gap: 5px; margin-top: 10px; display: none; }
        .input-com { flex-grow: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px; outline: none; }
        .btn-com { background: #ff9800; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <div id="miModal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background-color: rgba(0,0,0,0.9); text-align:center; align-items:center; justify-content:center;">
        <span onclick="cerrarFoto()" style="position:absolute; top:20px; right:35px; color:white; font-size:40px; font-weight:bold; cursor:pointer;">&times;</span>
        <img id="fotoGrande" style="max-width:90%; max-height:80%; border-radius:10px; box-shadow: 0 0 20px white; object-fit: contain;">
    </div>

    <div class="sidebar">
        <h1 style="margin: 0; font-size: 2rem;">üêæ Refugio üêæ</h1>
        <p style="opacity: 0.9; margin-bottom: 30px;">Encuentra a tu mejor amigo</p>
        
        <div style="width: 100%;">
            <input type="text" id="buscador" placeholder="üîç Buscar por nombre..." 
            style="width: 100%; box-sizing: border-box; padding: 15px; border: none; border-radius: 12px; font-size: 16px; outline: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        </div>

        <div style="margin-top: auto; font-size: 0.8rem; opacity: 0.7;">
            ¬© 2026 Refugio de Patitas
        </div>
    </div> 

    <div class="contenido-principal">
        <div class="contenedor" id="lista">Cargando perritos...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, query, orderBy, serverTimestamp, deleteDoc, doc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        const firebaseConfig = {
          apiKey: "AIzaSyB0ahP8K53dm8BIRhjXYxCbSJ8sNfQi-NI",
          authDomain: "refugio-de-patitas.firebaseapp.com",
          projectId: "refugio-de-patitas",
          storageBucket: "refugio-de-patitas.firebasestorage.app",
          messagingSenderId: "5921473252",
          appId: "1:5921473252:web:16f18c4c7cf1ad1509e2f1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const miNumero = "5218999508736"; 
        
        let nombreUsuario = localStorage.getItem('nombreUsuario');
        if (!nombreUsuario) {
            nombreUsuario = prompt("¬°Bienvenido! Danos tu nombre para poder comentar y dar likes:");
            if (!nombreUsuario) nombreUsuario = "Amigo an√≥nimo";
            localStorage.setItem('nombreUsuario', nombreUsuario);
        }

        let todosLosPerritos = [];

        onSnapshot(collection(db, "perritos"), (snap) => {
            todosLosPerritos = [];
            snap.forEach(doc => todosLosPerritos.push({ id: doc.id, ...doc.data() }));
            renderizarPerritos(todosLosPerritos);
        });

        function renderizarPerritos(datos) {
            const lista = document.getElementById('lista');
            lista.innerHTML = '';
            
            const idEnUrl = window.location.hash.replace('#', '');

            datos.forEach((p) => {
                const msj = `Hola! Me interesa preguntar por ${p.nombre}`;
                const linkWa = `https://wa.me/${miNumero}?text=${encodeURIComponent(msj)}`;
                
                const listaLikes = p.likes || [];
                const yaDioLike = listaLikes.includes(nombreUsuario);
                const iconoCorazon = yaDioLike ? "‚ù§Ô∏è" : "ü§ç";
                const totalLikes = listaLikes.length;

                const tarjeta = document.createElement('div');
                tarjeta.className = 'tarjeta';
                tarjeta.id = p.id; 
                
                if(p.id === idEnUrl) tarjeta.classList.add('tarjeta-destacada');

                // AQU√ç AGREGU√â LA RAZA
                tarjeta.innerHTML = `
                    <img src="${p.fotoUrl}" onclick="verFoto('${p.fotoUrl}')" onerror="this.src='https://via.placeholder.com/300x220?text=Error+en+Imagen'">
                    <div class="info">
                        <h3>${p.nombre}</h3>
                        
                        <div style="text-align:center; margin-bottom:10px;">
                            <span class="raza-badge"> ${p.raza || 'Mestizo'}</span>
                        </div>

                        <p><strong>Edad:</strong> ${p.edad}</p>
                        <p class="simbolo-sexo">${p.sexo || '‚ö†Ô∏è'}</p>
                        <p>${p.desc}</p>
                        <a href="${linkWa}" target="_blank" class="btn-wa">Pedir informes por WhatsApp</a>
                    </div>
                    
                    <div class="seccion-comentarios">
                        <div class="botones-accion" id="botones-${p.id}">
                            
                            <div class="cont-likes">
                                <button class="btn-like" onclick="toggleLike('${p.id}', ${yaDioLike})">${iconoCorazon}</button>
                                <span class="numero-likes" onclick="verListaLikes('${p.id}')" title="Ver qui√©n dio like">${totalLikes}</span>
                            </div>

                            <div class="grupo-botones-derecha">
                                <button class="btn-accion" onclick="toggleComentarios('${p.id}', false)">üí¨ Ver</button>
                                <button class="btn-accion" onclick="toggleComentarios('${p.id}', true)">‚úçÔ∏è</button>
                                <button class="btn-accion btn-compartir" onclick="compartirPerrito('${p.id}', '${p.nombre}')">üîó Compartir</button>
                            </div>
                        </div>

                        <div class="caja-comentarios-oculta" id="area-comentarios-${p.id}">
                            <div id="coms-${p.id}">Cargando...</div>
                            
                            <div class="area-escribir" id="area-input-${p.id}">
                                <input type="text" class="input-com" id="input-${p.id}" placeholder="Escribe tu opini√≥n...">
                                <button class="btn-com" onclick="enviarComentario('${p.id}')">Post</button>
                            </div>

                            <div style="text-align: center; margin-top: 10px;">
                                <button class="btn-accion" onclick="ocultarTodo('${p.id}')">üîº Ocultar</button>
                            </div>
                        </div>
                    </div>`;
                lista.appendChild(tarjeta);
                escucharComentarios(p.id);
            });

            if(idEnUrl) {
                setTimeout(() => {
                    const elemento = document.getElementById(idEnUrl);
                    if(elemento) elemento.scrollIntoView({behavior: "smooth", block: "center"});
                }, 1000); 
            }
        }

        window.compartirPerrito = async (id, nombre) => {
            const urlParaCompartir = window.location.href.split('#')[0] + '#' + id;
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: `Adopta a ${nombre} üêæ`,
                        text: `¬°Mira a este perrito del Refugio! Se llama ${nombre}.`,
                        url: urlParaCompartir
                    });
                } catch (err) { console.log('Cancelado por usuario'); }
            } else {
                navigator.clipboard.writeText(urlParaCompartir);
                alert("¬°Link copiado! P√©galo en Facebook, WhatsApp o donde quieras:\n\n" + urlParaCompartir);
            }
        };

        window.toggleLike = async (id, yaDioLike) => {
            const perroRef = doc(db, "perritos", id);
            try {
                if (yaDioLike) {
                    await updateDoc(perroRef, { likes: arrayRemove(nombreUsuario) });
                } else {
                    await updateDoc(perroRef, { likes: arrayUnion(nombreUsuario) });
                }
            } catch (e) { console.error(e); }
        };

        window.verListaLikes = (id) => {
            const perro = todosLosPerritos.find(p => p.id === id);
            if (perro && perro.likes && perro.likes.length > 0) {
                alert("‚ù§Ô∏è A estas personas les gusta " + perro.nombre + ":\n\n" + perro.likes.join("\n"));
            } else {
                alert("üíî Nadie le ha dado like a√∫n.");
            }
        };

        window.toggleComentarios = (id, quiereEscribir) => {
            const area = document.getElementById(`area-comentarios-${id}`);
            const inputArea = document.getElementById(`area-input-${id}`);
            const botones = document.getElementById(`botones-${id}`);
            area.style.display = "block";
            botones.style.display = "none"; 
            if(quiereEscribir) {
                inputArea.style.display = "flex"; 
                document.getElementById(`input-${id}`).focus(); 
            } else {
                inputArea.style.display = "none"; 
            }
        };

        window.ocultarTodo = (id) => {
            document.getElementById(`area-comentarios-${id}`).style.display = "none";
            document.getElementById(`botones-${id}`).style.display = "flex"; 
        };

        window.enviarComentario = async (idPerro) => {
            const texto = document.getElementById(`input-${idPerro}`).value;
            if(!texto) return;
            try {
                await addDoc(collection(db, "perritos", idPerro, "comentarios"), {
                    usuario: nombreUsuario,
                    texto: texto,
                    fecha: serverTimestamp()
                });
                document.getElementById(`input-${idPerro}`).value = '';
            } catch (e) { console.error(e); }
        };

        function escucharComentarios(idPerro) {
            const q = query(collection(db, "perritos", idPerro, "comentarios"), orderBy("fecha", "asc"));
            onSnapshot(q, (snap) => {
                const contenedor = document.getElementById(`coms-${idPerro}`);
                contenedor.innerHTML = '';
                snap.forEach(res => {
                    const c = res.data();
                    contenedor.innerHTML += `
                        <div class="comentario">
                            <span><b>${c.usuario}:</b> ${c.texto}</span>
                            <button class="btn-borrar-com" onclick="borrarComentario('${idPerro}', '${res.id}')">‚úï</button>
                        </div>`;
                });
                if(snap.empty) contenedor.innerHTML = '<i style="color:gray; font-size: 0.8rem;">No hay comentarios a√∫n.</i>';
            });
        }

        document.getElementById('buscador').oninput = (e) => {
            const texto = e.target.value.toLowerCase();
            const filtrados = todosLosPerritos.filter(perro => perro.nombre.toLowerCase().includes(texto));
            renderizarPerritos(filtrados);
        };

        window.verFoto = (url) => {
            const modal = document.getElementById("miModal");
            const img = document.getElementById("fotoGrande");
            modal.style.display = "flex";
            img.src = url;
        };

        window.cerrarFoto = () => { document.getElementById("miModal").style.display = "none"; };
        
        window.borrarComentario = async (idPerro, idComentario) => {
            if(confirm("¬øBorrar comentario?")) {
                try {
                    const comRef = doc(db, "perritos", idPerro, "comentarios", idComentario);
                    await deleteDoc(comRef);
                } catch (e) { alert("Error: " + e); }
            }
       };
    </script>
</body>
</html>
